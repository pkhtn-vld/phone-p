<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>webrtc-minimal</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 16px
    }

    button {
      padding: 8px 12px;
      margin: 6px
    }

    #log {
      white-space: pre-wrap;
      background: #f6f6f6;
      padding: 8px;
      border-radius: 6px;
      height: 240px;
      overflow: auto
    }
  </style>
</head>

<body>
  <h3>WebRTC minimal demo</h3>
  <div>
    <button id="btnLocal">Разрешить микрофон</button>
    <button id="btnCall">Позвонить (всем)</button>
    <button id="btnHang">Завершить</button>
  </div>
  <div>Ваш id: <span id="myId">-</span></div>

  <audio id="remoteAudio" autoplay playsinline></audio>

  <script>
    (async function () {
      const btnLocal = document.getElementById('btnLocal');
      const btnCall = document.getElementById('btnCall');
      const btnHang = document.getElementById('btnHang');
      const myIdEl = document.getElementById('myId');
      const remoteAudio = document.getElementById('remoteAudio');

      btnCall.disabled = true;
      remoteAudio.autoplay = true;
      remoteAudio.muted = true;
      remoteAudio.setAttribute('playsinline', '');

      let audioEnabled = false;
      let localStream = null;
      let pc = null;
      let myId = null;

      // Включение воспроизведения аудио (нужно для iOS/Safari)
      async function enableAudioPlayback() {
        if (!window.remoteAudioContext) {
          window.remoteAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        await window.remoteAudioContext.resume();
        remoteAudio.muted = false;
        if (remoteAudio.srcObject) await remoteAudio.play();
        audioEnabled = true;
        btnCall.disabled = false;
      }

      const enableBtn = document.getElementById('enableAudioBtn') || (() => {
        const b = document.createElement('button');
        b.id = 'enableAudioBtn';
        b.textContent = 'Включить звук';
        b.style.margin = '6px';
        document.body.insertBefore(b, document.getElementById('log'));
        return b;
      })();

      enableBtn.addEventListener('click', enableAudioPlayback);

      const ws = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/ws');

      function makeCallId() {
        return myId ? `${myId}-${Date.now()}` : `c-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
      }

      const response = await fetch("https://pwa-p.metered.live/api/v1/turn/credentials?apiKey=d294a2a2eadb04e549660dc431b109d1fa00");
      const iceServersAll = await response.json();

      // Создание PeerConnection
      function createPeerConnection(callId) {
        const connection = new RTCPeerConnection({
          iceServers: iceServers
        });
        connection.onicecandidate = e => { if (e.candidate) ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate, callId })); };
        connection.ontrack = e => {
          const stream = (e.streams && e.streams[0]) || e.stream || null;
          remoteAudio.srcObject = stream;
          if (audioEnabled) remoteAudio.play().catch(() => { });
        };
        if (localStream) localStream.getTracks().forEach(t => connection.addTrack(t, localStream));
        return connection;
      }

      ws.addEventListener('message', async ev => {
        let msg; try { msg = JSON.parse(ev.data); } catch (e) { return; }

        if (msg.type === 'welcome') {
          myId = msg.id;
          myIdEl.textContent = myId;
          return;
        }

        if (msg.type === 'offer') {
          if (pc) pc.close();
          const callId = msg.callId || makeCallId();
          pc = createPeerConnection(callId);
          await pc.setRemoteDescription({ type: 'offer', sdp: msg.sdp });
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp, callId }));
          return;
        }

        if (msg.type === 'answer' && pc) {
          await pc.setRemoteDescription({ type: 'answer', sdp: msg.sdp }).catch(() => { });
          return;
        }

        if (msg.type === 'candidate' && pc) {
          await pc.addIceCandidate(msg.candidate).catch(() => { });
        }
      });

      btnLocal.addEventListener('click', async () => {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true }).catch(() => null);
      });

      btnCall.addEventListener('click', async () => {
        if (!audioEnabled) return alert('Нажмите «Включить звук» перед звонком.');
        if (pc) pc.close();
        const callId = makeCallId();
        pc = createPeerConnection(callId);
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: 'offer', sdp: offer.sdp }));
      });

      btnHang.addEventListener('click', () => {
        if (pc) pc.close();
        pc = null;
        if (localStream) localStream.getTracks().forEach(t => t.stop());
        localStream = null;
        if (window.remoteAudioContext) window.remoteAudioContext.close().catch(() => { });
        window.remoteAudioContext = null;
        audioEnabled = false;
      });
    })();
  </script>
</body>

</html>